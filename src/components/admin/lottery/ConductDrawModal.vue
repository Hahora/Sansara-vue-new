<template>
  <div
    v-if="isOpen"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] overflow-y-auto p-2 sm:p-4"
    @click.self="close"
  >
    <div
      class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] sm:max-h-[80vh] overflow-hidden flex flex-col"
    >
      <!-- –®–∞–ø–∫–∞ -->
      <div
        class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-3 sm:px-6 sm:py-4 rounded-t-xl z-10"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <span class="text-2xl sm:text-3xl mr-2 sm:mr-3">üéüÔ∏è</span>
            <h3 class="font-bold text-lg sm:text-xl">–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞</h3>
          </div>
          <button @click="close" class="text-white hover:text-gray-200">
            <svg
              class="w-5 h-5 sm:w-6 sm:h-6"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
      <div class="flex-1 overflow-y-auto p-3 sm:p-6">
        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
        <div
          class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-3 sm:p-4 mb-4 sm:mb-6"
        >
          <div class="flex items-start">
            <svg
              class="w-5 h-5 sm:w-6 sm:h-6 text-red-500 mr-2 sm:mr-3 flex-shrink-0 mt-0.5"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
            <div>
              <h4 class="font-bold text-red-800 mb-1 text-sm sm:text-base">
                –í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å
              </h4>
              <p class="text-red-700 text-xs sm:text-sm">
                –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –ª–æ—Ç–µ—Ä–µ—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞, –∞ –≤—Å–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
              </p>
            </div>
          </div>
        </div>

        <!-- –í—ã–±–æ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <div class="mb-4 sm:mb-6">
          <label
            class="block text-xs sm:text-sm font-bold text-gray-700 mb-2 sm:mb-3"
          >
            üì§ –í—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          </label>
          <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
          </p>

          <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
          <div class="mb-3">
            <div class="relative">
              <input
                v-model="userSearch"
                @input="searchUsers"
                type="text"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, @username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
                class="w-full px-3 py-2.5 sm:py-3 pr-10 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
              />
              <svg
                class="absolute right-3 top-3 sm:top-3.5 w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </div>
          </div>

          <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∏—Å–∫–∞ -->
          <div v-if="isSearching" class="flex justify-center items-center py-6">
            <div class="relative">
              <div
                class="animate-spin rounded-full h-8 w-8 border-4 border-gray-200"
              ></div>
              <div
                class="animate-spin rounded-full h-8 w-8 border-4 border-purple-600 border-t-transparent absolute top-0 left-0"
              ></div>
            </div>
          </div>

          <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
          <div
            v-else-if="searchResults.length > 0"
            class="space-y-2 max-h-56 sm:max-h-64 overflow-y-auto"
          >
            <button
              v-for="user in searchResults"
              :key="user.id"
              @click="selectUser(user)"
              :class="[
                'w-full text-left p-3 sm:p-4 rounded-lg border-2 transition-all',
                selectedUserId === user.id
                  ? 'border-purple-500 bg-purple-50'
                  : 'border-gray-200 hover:border-purple-300 bg-white',
              ]"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span
                      class="font-semibold text-gray-900 text-sm sm:text-base truncate"
                    >
                      {{ user.first_name }}
                      {{ user.last_name || "" }}
                    </span>
                    <span
                      v-if="selectedUserId === user.id"
                      class="text-purple-600 flex-shrink-0 text-lg"
                    >
                      ‚úì
                    </span>
                  </div>
                  <div class="text-xs sm:text-sm text-gray-600 truncate">
                    <span v-if="user.username">@{{ user.username }}</span>
                    <span v-else class="text-gray-400">–ë–µ–∑ username</span>
                  </div>
                  <div
                    v-if="user.phone"
                    class="text-xs text-gray-500 mt-1 truncate"
                  >
                    üìû {{ user.phone }}
                  </div>
                </div>
                <div
                  :class="[
                    'w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0',
                    selectedUserId === user.id
                      ? 'border-purple-500 bg-purple-500'
                      : 'border-gray-300',
                  ]"
                >
                  <svg
                    v-if="selectedUserId === user.id"
                    class="w-4 h-4 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
              </div>
            </button>
          </div>

          <!-- –ü—É—Å—Ç–æ -->
          <div
            v-else-if="userSearch.length > 0 && !isSearching"
            class="text-center py-8 text-gray-500"
          >
            <svg
              class="w-12 h-12 mx-auto mb-3 text-gray-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <p class="text-sm">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <p class="text-xs text-gray-400 mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
          </div>

          <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
          <div v-else class="text-center py-8 text-gray-400">
            <svg
              class="w-12 h-12 mx-auto mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <p class="text-sm">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è, @username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</p>
          </div>
        </div>

        <!-- –û–ø—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ - –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–∞, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º -->
        <!-- cleanup_after_draw –≤—Å–µ–≥–¥–∞ true -->

        <!-- –û—à–∏–±–∫–∞ -->
        <div
          v-if="error"
          class="mt-4 bg-red-50 border-l-4 border-red-500 rounded-r p-3"
        >
          <p class="text-sm text-red-800">{{ error }}</p>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div class="sticky bottom-0 bg-white border-t border-gray-200 p-3 sm:p-4">
        <div class="flex gap-2 sm:gap-3">
          <button
            type="button"
            @click="close"
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 sm:py-3 px-3 sm:px-4 rounded-lg transition-all active:scale-98 text-sm sm:text-base"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="button"
            @click="confirmDraw"
            :disabled="!selectedUserId || isConducting"
            class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-2.5 sm:py-3 px-3 sm:px-4 rounded-lg transition-all active:scale-98 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base"
          >
            <span v-if="!isConducting" class="flex items-center justify-center">
              <span class="text-lg sm:text-xl mr-1.5 sm:mr-2">üéüÔ∏è</span>
              –ü—Ä–æ–≤–µ—Å—Ç–∏
            </span>
            <span v-else class="flex items-center justify-center">
              <svg
                class="animate-spin h-4 w-4 sm:h-5 sm:w-5 mr-1.5 sm:mr-2"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { userAPI, lotteryAPI } from "@/utils/api";

export default {
  name: "ConductDrawModal",
  props: {
    isOpen: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      isSearching: false,
      isConducting: false,
      error: null,
      userSearch: "",
      searchResults: [],
      selectedUserId: null,
      cleanupAfterDraw: true,
      scrollY: 0,
      searchTimeout: null,
    };
  },
  watch: {
    isOpen(newVal) {
      if (newVal) {
        this.lockBodyScroll();
        this.loadUsers();
      } else {
        this.unlockBodyScroll();
      }
    },
  },
  methods: {
    lockBodyScroll() {
      this.scrollY = window.scrollY;
      document.body.style.position = "fixed";
      document.body.style.top = `-${this.scrollY}px`;
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
    },

    unlockBodyScroll() {
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
      window.scrollTo(0, this.scrollY);
    },

    searchUsers() {
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
      if (this.searchTimeout) {
        clearTimeout(this.searchTimeout);
      }

      // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ - –æ—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      if (!this.userSearch.trim()) {
        this.searchResults = [];
        return;
      }

      // Debounce - –∂–¥—ë–º 300–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–≤–æ–¥–∞
      this.searchTimeout = setTimeout(async () => {
        try {
          this.isSearching = true;
          this.error = null;

          const data = await userAPI.getAll();

          if (!Array.isArray(data)) {
            this.searchResults = [];
            return;
          }

          // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–ø—Ä–æ—Å—É
          const query = this.userSearch.toLowerCase().trim();
          this.searchResults = data.filter((user) => {
            const firstName = (user.first_name || "").toLowerCase();
            const lastName = (user.last_name || "").toLowerCase();
            const username = (user.username || "").toLowerCase();
            const phone = (user.phone || "").toLowerCase();

            return (
              firstName.includes(query) ||
              lastName.includes(query) ||
              username.includes(query) ||
              phone.includes(query) ||
              `${firstName} ${lastName}`.includes(query)
            );
          });

          console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:", this.searchResults.length);
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
          this.error = "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π";
          this.searchResults = [];
        } finally {
          this.isSearching = false;
        }
      }, 300);
    },

    selectUser(user) {
      this.selectedUserId = user.id;
      console.log(
        "–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:",
        user.id,
        user.first_name,
        user.last_name
      );
    },

    async confirmDraw() {
      if (!this.selectedUserId) {
        this.error = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞";
        return;
      }

      try {
        this.isConducting = true;
        this.error = null;

        console.log("–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞:", {
          admin_user_id: this.selectedUserId,
          cleanup_after_draw: this.cleanupAfterDraw,
        });

        // –í—ã–∑—ã–≤–∞–µ–º API —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        await lotteryAPI.conductDraw({
          admin_user_id: this.selectedUserId,
          cleanup_after_draw: this.cleanupAfterDraw,
        });

        console.log("–†–æ–∑—ã–≥—Ä—ã—à —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω");

        this.$emit("success");
        this.close();
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞:", error);
        this.error = error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à";
      } finally {
        this.isConducting = false;
      }
    },

    close() {
      this.$emit("close");
    },
  },
  beforeDestroy() {
    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    if (this.searchTimeout) {
      clearTimeout(this.searchTimeout);
    }
    this.unlockBodyScroll();
  },
};
</script>

<style scoped>
.active\:scale-98:active {
  transform: scale(0.98);
}
</style>
