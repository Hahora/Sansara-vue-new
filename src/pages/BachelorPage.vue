<template>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white pb-20">
    <!-- –®–∞–ø–∫–∞ -->
    <div
      class="bg-gradient-to-br from-[#4e5d51] via-[#5a6d5e] to-[#4e5d51] text-white px-5 py-6"
    >
      <div class="flex items-center mb-4">
        <button
          @click="$router.go(-1)"
          class="flex items-center text-white hover:text-gray-200 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd"
            />
          </svg>
          <span class="font-medium">–ù–∞–∑–∞–¥</span>
        </button>
      </div>

      <div class="flex items-center">
        <div
          class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-full flex items-center justify-center text-3xl border-2 border-white border-opacity-30"
        >
          üéâ
        </div>
        <div class="ml-4 flex-1">
          <h1 class="text-2xl font-bold">{{ pageTitle }}</h1>
          <p class="text-white text-opacity-90 text-sm mt-1">
            –ü—Ä–∞–∑–¥–Ω—É–π—Ç–µ –≤–∞–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ –æ—Å–æ–±–µ–Ω–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ
          </p>
        </div>
      </div>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="px-4 py-3 border-b border-gray-200 bg-white">
      <div class="flex rounded-lg bg-gray-100 p-1">
        <button
          @click="activeTab = 'info'"
          :class="[
            'flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-200',
            activeTab === 'info'
              ? 'bg-white shadow-sm text-[#4e5d51]'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        </button>
        <button
          @click="activeTab = 'gallery'"
          :class="[
            'flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-200',
            activeTab === 'gallery'
              ? 'bg-white shadow-sm text-[#4e5d51]'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          üì∏ –ì–∞–ª–µ—Ä–µ—è
        </button>
      </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-16">
      <div class="relative">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200"
        ></div>
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-[#4e5d51] border-t-transparent absolute top-0 left-0"
        ></div>
      </div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div
      v-else-if="error"
      class="mx-4 mt-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4 shadow-sm"
    >
      <div class="flex items-start">
        <svg
          class="h-5 w-5 text-red-500 mt-0.5 mr-3"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="text-sm text-red-800">{{ error }}</p>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div v-else-if="activeTab === 'info'" class="px-4 py-5 space-y-4">
      <!-- –ú–∞–ª—å—á–∏—à–Ω–∏–∫–∏ -->
      <div
        v-if="bachelorContent && bachelorContent.title"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 space-y-3"
      >
        <div class="flex items-center">
          <span class="text-2xl mr-3">üëî</span>
          <div>
            <h2 class="font-semibold text-gray-900">
              {{ bachelorContent.title || "–ú–∞–ª—å—á–∏—à–Ω–∏–∫–∏" }}
            </h2>
          </div>
        </div>

        <!-- –¶–µ–Ω–∞ -->
        <div v-if="bachelorContent.price" class="flex items-center">
          <div
            class="bg-green-50 text-green-800 px-4 py-2 rounded-lg border border-green-200"
          >
            <div class="flex items-center">
              <span class="font-bold text-lg">{{
                formatPrice(bachelorContent.price)
              }}</span>
              <span class="text-sm ml-2 text-green-600">/ —Å –≥–æ—Å—Ç—è</span>
            </div>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ API -->
        <div
          v-if="bachelorContent.content"
          class="bg-gray-50 rounded-lg p-3 prose prose-sm max-w-none"
        >
          <div v-html="formatContent(bachelorContent.content)"></div>
        </div>

        <!-- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç -->
        <div
          v-else
          class="bg-gray-50 rounded-lg p-3 text-center text-gray-500 italic"
        >
          –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–ª—å—á–∏—à–Ω–∏–∫–∞—Ö —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <button
          @click="openBooking('BACHELOR', '–ú–∞–ª—å—á–∏—à–Ω–∏–∫')"
          class="w-full bg-[#4e5d51] hover:bg-[#3d4a40] text-white font-semibold py-4 px-4 rounded-xl transition-all duration-200 text-center shadow-sm active:scale-98"
        >
          üìù –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞–ª—å—á–∏—à–Ω–∏–∫
        </button>
      </div>

      <!-- –î–µ–≤–∏—á–Ω–∏–∫–∏ -->
      <div
        v-if="bacheloretteContent && bacheloretteContent.title"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 space-y-3"
      >
        <div class="flex items-center">
          <span class="text-2xl mr-3">üëó</span>
          <div>
            <h2 class="font-semibold text-gray-900">
              {{ bacheloretteContent.title || "–î–µ–≤–∏—á–Ω–∏–∫–∏" }}
            </h2>
          </div>
        </div>

        <!-- –¶–µ–Ω–∞ -->
        <div v-if="bacheloretteContent.price" class="flex items-center">
          <div
            class="bg-green-50 text-green-800 px-4 py-2 rounded-lg border border-green-200"
          >
            <div class="flex items-center">
              <span class="font-bold text-lg">{{
                formatPrice(bacheloretteContent.price)
              }}</span>
              <span class="text-sm ml-2 text-green-600">/ —Å –≥–æ—Å—Ç—è</span>
            </div>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ API -->
        <div
          v-if="bacheloretteContent.content"
          class="bg-gray-50 rounded-lg p-3 prose prose-sm max-w-none"
        >
          <div v-html="formatContent(bacheloretteContent.content)"></div>
        </div>

        <!-- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç -->
        <div
          v-else
          class="bg-gray-50 rounded-lg p-3 text-center text-gray-500 italic"
        >
          –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–≤–∏—á–Ω–∏–∫–∞—Ö —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <button
          @click="openBooking('BACHELORETTE', '–î–µ–≤–∏—á–Ω–∏–∫')"
          class="w-full bg-[#4e5d51] hover:bg-[#3d4a40] text-white font-semibold py-4 px-4 rounded-xl transition-all duration-200 text-center shadow-sm active:scale-98"
        >
          üìù –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–≤–∏—á–Ω–∏–∫
        </button>
      </div>

      <!-- –ï—Å–ª–∏ –æ–±–∞ —Ä–∞–∑–¥–µ–ª–∞ –ø—É—Å—Ç—ã–µ -->
      <div
        v-if="
          (!bachelorContent || !bachelorContent.title) &&
          (!bacheloretteContent || !bacheloretteContent.title)
        "
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center"
      >
        <div class="text-4xl mb-4">üéâ</div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–ª—å—á–∏—à–Ω–∏–∫–∞—Ö –∏ –¥–µ–≤–∏—á–Ω–∏–∫–∞—Ö
        </h3>
        <p class="text-gray-600">
          –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—à–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö
        </p>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è -->
    <div v-else-if="activeTab === 'gallery'" class="pb-20">
      <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ -->
      <MediaGallery
        :sections="['BACHELOR', 'BACHELORETTE']"
        :show-media-type-filter="true"
        :category-labels="{
          BACHELOR: '–ú–∞–ª—å—á–∏—à–Ω–∏–∫–∏',
          BACHELORETTE: '–î–µ–≤–∏—á–Ω–∏–∫–∏',
        }"
      />
    </div>
  </div>
</template>

<script>
import { mapState, mapActions } from "pinia";
import { useAppStore } from "@/stores/appStore";
import { openBookingModal } from "@/utils/eventBus";
import MediaGallery from "@/components/MediaGallery.vue";

export default {
  name: "BachelorPage",
  components: {
    MediaGallery,
  },
  data() {
    return {
      isLoading: false,
      error: null,
      bachelorContent: null,
      bacheloretteContent: null,
      activeTab: "info", // 'info' –∏–ª–∏ 'gallery'
      selectedEventType: null, // –î–ª—è –≥–∞–ª–µ—Ä–µ–∏
    };
  },
  computed: {
    ...mapState(useAppStore, ["selectedBranch", "contentData"]),

    pageTitle() {
      const bachelorTitle = this.contentData?.["BACHELOR"]?.title;
      const bacheloretteTitle = this.contentData?.["BACHELORETTE"]?.title;

      if (bachelorTitle || bacheloretteTitle) {
        return "–ú–∞–ª—å—á–∏—à–Ω–∏–∫–∏ –∏ –¥–µ–≤–∏—á–Ω–∏–∫–∏";
      }
      return "–ú–∞–ª—å—á–∏—à–Ω–∏–∫–∏ –∏ –¥–µ–≤–∏—á–Ω–∏–∫–∏";
    },
  },
  methods: {
    ...mapActions(useAppStore, ["loadSiteContent"]),

    formatContent(content) {
      if (!content) return "";
      return content
        .replace(/\n/g, "<br>")
        .replace(/\\n/g, "<br>")
        .replace(/\r\n/g, "<br>");
    },

    formatPrice(price) {
      if (!price && price !== 0) return "";

      const priceNumber = Number(price);
      if (isNaN(priceNumber)) return price;

      return priceNumber.toLocaleString("ru-RU") + " ‚ÇΩ";
    },

    async loadContent() {
      try {
        this.isLoading = true;
        this.error = null;

        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–∞–ª—å—á–∏—à–Ω–∏–∫–æ–≤/–¥–µ–≤–∏—á–Ω–∏–∫–æ–≤");
        console.log("–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª–∏–∞–ª:", this.selectedBranch?.id);

        try {
          await this.loadSiteContent("BACHELOR", true);
          this.bachelorContent = this.contentData?.["BACHELOR"];
          console.log("–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –º–∞–ª—å—á–∏—à–Ω–∏–∫–æ–≤:", this.bachelorContent);
        } catch (bachelorError) {
          console.error(
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –º–∞–ª—å—á–∏—à–Ω–∏–∫–æ–≤:",
            bachelorError
          );
          this.bachelorContent = null;
        }

        try {
          await this.loadSiteContent("BACHELORETTE", true);
          this.bacheloretteContent = this.contentData?.["BACHELORETTE"];
          console.log("–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –¥–µ–≤–∏—á–Ω–∏–∫–æ–≤:", this.bacheloretteContent);
        } catch (bacheloretteError) {
          console.error(
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –¥–µ–≤–∏—á–Ω–∏–∫–æ–≤:",
            bacheloretteError
          );
          this.bacheloretteContent = null;
        }

        if (!this.bachelorContent && !this.bacheloretteContent) {
          console.log("–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ–±–æ–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:", error);
        this.error = error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é";
      } finally {
        this.isLoading = false;
      }
    },

    openBooking(eventKey, title) {
      console.log("BachelorPage: Opening booking", { eventKey, title });
      this.selectedEventType = eventKey; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
      openBookingModal(null, eventKey, title);
    },
  },
  async created() {
    console.log("BachelorPage created");

    try {
      await this.loadContent();
      console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:", error);
      this.error = error.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã";
    }
  },

  watch: {
    "selectedBranch.id": {
      handler(newBranchId) {
        console.log("–§–∏–ª–∏–∞–ª –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç:", newBranchId);
        this.loadContent();
      },
    },
  },
};
</script>

<style scoped>
.active\:scale-98:active {
  transform: scale(0.98);
}

.prose :deep(p) {
  margin-bottom: 0.75em;
}

.prose :deep(ul) {
  margin-bottom: 0.75em;
  padding-left: 1.5em;
  list-style-type: disc;
}

.prose :deep(li) {
  margin-bottom: 0.25em;
}

.prose :deep(strong) {
  font-weight: 600;
  color: #111827;
}
</style>
