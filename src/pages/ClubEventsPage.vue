<template>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white pb-20">
    <!-- –®–∞–ø–∫–∞ -->
    <div
      class="bg-gradient-to-br from-[#4e5d51] via-[#5a6d5e] to-[#4e5d51] text-white px-5 py-6"
    >
      <div class="flex items-center mb-4">
        <button
          @click="$router.go(-1)"
          class="flex items-center text-white hover:text-gray-200 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd"
            />
          </svg>
          <span class="font-medium">–ù–∞–∑–∞–¥</span>
        </button>
      </div>

      <div class="flex items-center">
        <div
          class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-full flex items-center justify-center text-3xl border-2 border-white border-opacity-30"
        >
          üèõ
        </div>
        <div class="ml-4 flex-1">
          <h1 class="text-2xl font-bold">{{ pageTitle }}</h1>
        </div>
      </div>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="px-4 py-3 border-b border-gray-200 bg-white">
      <div class="flex rounded-lg bg-gray-100 p-1">
        <button
          @click="activeTab = 'info'"
          :class="[
            'flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-200',
            activeTab === 'info'
              ? 'bg-white shadow-sm text-[#4e5d51]'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        </button>
        <button
          @click="activeTab = 'gallery'"
          :class="[
            'flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-200',
            activeTab === 'gallery'
              ? 'bg-white shadow-sm text-[#4e5d51]'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          üì∏ –ì–∞–ª–µ—Ä–µ—è
        </button>
      </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-16">
      <div class="relative">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200"
        ></div>
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-[#4e5d51] border-t-transparent absolute top-0 left-0"
        ></div>
      </div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div
      v-else-if="error"
      class="mx-4 mt-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4 shadow-sm"
    >
      <div class="flex items-start">
        <svg
          class="h-5 w-5 text-red-500 mt-0.5 mr-3"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="text-sm text-red-800">{{ error }}</p>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div v-else-if="activeTab === 'info'" class="px-4 py-5">
      <!-- –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º -->
      <div
        v-if="
          (!bathClubContent || !bathClubContent.title) &&
          (!businessBathContent || !businessBathContent.title)
        "
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center"
      >
        <div class="text-4xl mb-4">üèõ</div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          –ö–ª—É–±–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        </h3>
        <p class="text-gray-600">
          –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—É–±–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö
        </p>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∫–ª—É–±–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
      <div v-else class="space-y-4">
        <!-- –ë–∞–Ω–Ω—ã–π –∫–ª—É–± –°. –•–∞—á–∞—Ç—É—Ä—å—è–Ω–∞ -->
        <div
          v-if="bathClubContent && bathClubContent.title"
          class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
        >
          <div
            class="px-4 py-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-gray-100"
          >
            <div class="flex items-center">
              <span class="text-3xl mr-3">‚ô®Ô∏è</span>
              <div class="flex-1">
                <h2 class="font-bold text-gray-900 text-lg">
                  {{ bathClubContent.title }}
                </h2>
                <p v-if="bathClubSubtitle" class="text-sm text-gray-600 mt-0.5">
                  {{ bathClubSubtitle }}
                </p>
              </div>
            </div>
          </div>

          <div class="p-4 space-y-4">
            <!-- –¶–µ–Ω–∞ -->
            <div v-if="bathClubContent.price" class="flex items-center">
              <div
                class="bg-green-50 text-green-800 px-4 py-2 rounded-lg border border-green-200"
              >
                <div class="flex items-center">
                  <span class="font-bold text-lg">{{
                    formatPrice(bathClubContent.price)
                  }}</span>
                  <span class="text-sm ml-2 text-green-600">/ —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞</span>
                </div>
              </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ API -->
            <div
              v-if="bathClubContent.content"
              class="prose prose-sm max-w-none"
            >
              <div v-html="formatContent(bathClubContent.content)"></div>
            </div>

            <!-- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç -->
            <div
              v-else
              class="bg-gray-50 rounded-lg p-3 text-center text-gray-500 italic"
            >
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–Ω–æ–º –∫–ª—É–±–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ - –ò–ó–ú–ï–ù–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø–æ–¥—Ö–æ–¥, —á—Ç–æ –∏ –≤ –º–∞–ª—å—á–∏—à–Ω–∏–∫–∞—Ö -->
            <button
              @click="
                openBooking('BATH_CLUB', bathClubContent.title || '–ë–∞–Ω–Ω—ã–π –∫–ª—É–±')
              "
              class="w-full bg-[#4e5d51] hover:bg-[#3d4a40] text-white font-semibold py-4 px-4 rounded-xl transition-all duration-200 flex items-center justify-center shadow-sm active:scale-98"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                <path
                  d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"
                />
              </svg>
              –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–ª—É–±
            </button>
          </div>
        </div>

        <!-- –ë–∏–∑–Ω–µ—Å-–±–∞–Ω—è —Å –∫–ª—É–±–æ–º –ú–û–°–¢ -->
        <div
          v-if="businessBathContent && businessBathContent.title"
          class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
        >
          <div
            class="px-4 py-4 bg-gradient-to-r from-blue-50 to-cyan-50 border-b border-gray-100"
          >
            <div class="flex items-center">
              <span class="text-3xl mr-3">üíº</span>
              <div class="flex-1">
                <h2 class="font-bold text-gray-900 text-lg">
                  {{ businessBathContent.title }}
                </h2>
              </div>
            </div>
          </div>

          <div class="p-4 space-y-4">
            <!-- –¶–µ–Ω–∞ -->
            <div v-if="businessBathContent.price" class="flex items-center">
              <div
                class="bg-green-50 text-green-800 px-4 py-2 rounded-lg border border-green-200"
              >
                <div class="flex items-center">
                  <span class="font-bold text-lg">{{
                    formatPrice(businessBathContent.price)
                  }}</span>
                  <span class="text-sm ml-2 text-green-600">/ —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞</span>
                </div>
              </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ API -->
            <div
              v-if="businessBathContent.content"
              class="prose prose-sm max-w-none"
            >
              <div v-html="formatContent(businessBathContent.content)"></div>
            </div>

            <!-- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç -->
            <div
              v-else
              class="bg-gray-50 rounded-lg p-3 text-center text-gray-500 italic"
            >
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å-–±–∞–Ω–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏ - –ò–ó–ú–ï–ù–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø–æ–¥—Ö–æ–¥, —á—Ç–æ –∏ –≤ –º–∞–ª—å—á–∏—à–Ω–∏–∫–∞—Ö -->
            <button
              @click="
                openBooking(
                  'BUSINESS_BATH',
                  businessBathContent.title || '–ë–∏–∑–Ω–µ—Å-–±–∞–Ω—è'
                )
              "
              class="w-full bg-[#4e5d51] hover:bg-[#3d4a40] text-white font-semibold py-4 px-4 rounded-xl transition-all duration-200 flex items-center justify-center shadow-sm active:scale-98"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                <path
                  d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"
                />
              </svg>
              –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–∏–∑–Ω–µ—Å-–±–∞–Ω—é
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è -->
    <div v-else-if="activeTab === 'gallery'">
      <MediaGallery
        :sections="gallerySections"
        :show-media-type-filter="true"
        :category-labels="categoryLabels"
      />
    </div>
  </div>
</template>

<script>
import { mapState, mapActions } from "pinia";
import { useAppStore } from "@/stores/appStore";
import { openBookingModal } from "@/utils/eventBus"; // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç, –∫–∞–∫ –≤ –º–∞–ª—å—á–∏—à–Ω–∏–∫–∞—Ö
import MediaGallery from "@/components/MediaGallery.vue";

export default {
  name: "ClubEventsPage",
  components: {
    MediaGallery,
  },
  data() {
    return {
      isLoading: false,
      error: null,
      bathClubContent: null, // –ë–ê–ù–ù–´–ô –ö–õ–£–ë –°. –•–ê–ß–ê–¢–£–†–¨–Ø–ù
      businessBathContent: null, // –ë–∏–∑–Ω–µ—Å-–±–∞–Ω—è –ú–û–°–¢
      activeTab: "info", // 'info' –∏–ª–∏ 'gallery'
    };
  },
  computed: {
    ...mapState(useAppStore, [
      "programs",
      "programsLoaded",
      "selectedBranch",
      "contentData",
    ]),

    pageTitle() {
      return this.contentData?.["CLUB_EVENTS"]?.title || "–ö–ª—É–±–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è";
    },

    bathClubSubtitle() {
      return this.contentData?.["BATH_CLUB"]?.subtitle || "";
    },

    gallerySections() {
      return ["BATH_CLUB", "BUSINESS_BATH"];
    },

    categoryLabels() {
      return {
        BATH_CLUB: "–ë–∞–Ω–Ω—ã–π –∫–ª—É–±",
        BUSINESS_BATH: "–ë–∏–∑–Ω–µ—Å-–±–∞–Ω—è",
      };
    },
  },
  methods: {
    ...mapActions(useAppStore, ["loadPrograms", "loadSiteContent"]),

    formatContent(content) {
      if (!content) return "";
      return content
        .replace(/\n/g, "<br>")
        .replace(/\\n/g, "<br>")
        .replace(/\r\n/g, "<br>");
    },

    formatPrice(price) {
      if (!price && price !== 0) return "";

      const priceNumber = Number(price);
      if (isNaN(priceNumber)) return price;

      return priceNumber.toLocaleString("ru-RU") + " ‚ÇΩ";
    },

    // –ù–û–í–´–ô –ú–ï–¢–û–î - —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ –º–∞–ª—å—á–∏—à–Ω–∏–∫–∞—Ö
    openBooking(eventKey, title) {
      console.log("ClubEventsPage: Opening booking", { eventKey, title });
      openBookingModal(null, eventKey, title);
    },

    // –£–±—Ä–∞–ª–∏ –º–µ—Ç–æ–¥ findProgramForBooking, —Ç–∞–∫ –∫–∞–∫ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
    // –ü–æ–∏—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

    async loadClubEvents() {
      try {
        this.isLoading = true;
        this.error = null;

        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–ª—É–±–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π");
        console.log("–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª–∏–∞–ª:", this.selectedBranch?.id);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è BATH_CLUB
        try {
          await this.loadSiteContent("BATH_CLUB", true);
          this.bathClubContent = this.contentData?.["BATH_CLUB"];
          console.log("–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –±–∞–Ω–Ω–æ–≥–æ –∫–ª—É–±–∞:", this.bathClubContent);
        } catch (bathClubError) {
          console.error(
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –±–∞–Ω–Ω–æ–≥–æ –∫–ª—É–±–∞:",
            bathClubError
          );
          this.bathClubContent = null;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è BUSINESS_BATH
        try {
          await this.loadSiteContent("BUSINESS_BATH", true);
          this.businessBathContent = this.contentData?.["BUSINESS_BATH"];
          console.log("–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å-–±–∞–Ω–∏:", this.businessBathContent);
        } catch (businessBathError) {
          console.error(
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å-–±–∞–Ω–∏:",
            businessBathError
          );
          this.businessBathContent = null;
        }

        if (!this.bathClubContent && !this.businessBathContent) {
          console.log("–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ–±–æ–∏—Ö –∫–ª—É–±–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:", error);
        this.error = error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é";
      } finally {
        this.isLoading = false;
      }
    },
  },
  async created() {
    console.log("ClubEventsPage created");

    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      await this.loadClubEvents();

      console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:", error);
      this.error = error.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã";
    }
  },

  watch: {
    "selectedBranch.id": {
      handler(newBranchId) {
        console.log("–§–∏–ª–∏–∞–ª –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç:", newBranchId);
        this.loadClubEvents();
      },
    },
  },
};
</script>

<style scoped>
.active\:scale-98:active {
  transform: scale(0.98);
}

.prose :deep(p) {
  margin-bottom: 0.75em;
}

.prose :deep(ul) {
  margin-bottom: 0.75em;
  padding-left: 1.5em;
  list-style-type: disc;
}

.prose :deep(li) {
  margin-bottom: 0.25em;
}

.prose :deep(strong) {
  font-weight: 600;
  color: #111827;
}
</style>
