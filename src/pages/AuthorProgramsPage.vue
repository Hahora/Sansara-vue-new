<template>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white pb-20">
    <!-- –®–∞–ø–∫–∞ -->
    <div
      class="bg-gradient-to-br from-[#4e5d51] via-[#5a6d5e] to-[#4e5d51] text-white px-5 py-6"
    >
      <div class="flex items-center mb-4">
        <button
          @click="$router.go(-1)"
          class="flex items-center text-white hover:text-gray-200 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd"
            />
          </svg>
          <span class="font-medium">–ù–∞–∑–∞–¥</span>
        </button>
      </div>

      <div class="flex items-center">
        <div
          class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-full flex items-center justify-center text-3xl border-2 border-white border-opacity-30"
        >
          ‚ú®
        </div>
        <div class="ml-4 flex-1">
          <h1 class="text-2xl font-bold">–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h1>
          <p class="text-white text-opacity-90 text-sm mt-1">
            –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏, –≥–ª—É–±–æ–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Ä–∞–±–æ—Ç–∞ —Å —Ç–µ–ª–æ–º –∏ —ç–Ω–µ—Ä–≥–∏–µ–π
          </p>
        </div>
      </div>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="px-4 py-3 border-b border-gray-200 bg-white">
      <div class="flex rounded-lg bg-gray-100 p-1">
        <button
          @click="activeTab = 'info'"
          :class="[
            'flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-200',
            activeTab === 'info'
              ? 'bg-white shadow-sm text-[#4e5d51]'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        </button>
        <button
          @click="activeTab = 'gallery'"
          :class="[
            'flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-200',
            activeTab === 'gallery'
              ? 'bg-white shadow-sm text-[#4e5d51]'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          üì∏ –ì–∞–ª–µ—Ä–µ—è
        </button>
      </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-16">
      <div class="relative">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200"
        ></div>
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-[#4e5d51] border-t-transparent absolute top-0 left-0"
        ></div>
      </div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div
      v-else-if="error"
      class="mx-4 mt-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4 shadow-sm"
    >
      <div class="flex items-start">
        <svg
          class="h-5 w-5 text-red-500 mt-0.5 mr-3"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="text-sm text-red-800">{{ error }}</p>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div v-else-if="activeTab === 'info'" class="px-4 py-5">
      <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
      <div
        v-if="pageContent"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4"
      >
        <h3 class="font-semibold text-gray-900 mb-3">
          –û–± –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö
        </h3>
        <div
          class="text-sm text-gray-700 leading-relaxed whitespace-pre-line mb-4"
        >
          {{ pageContent }}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="space-y-2">
          <!-- –ü–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É -->
          <button
            @click="openRecommendationModal"
            class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center shadow-sm active:scale-98"
          >
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            –ü–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –º–µ–Ω—è
          </button>

          <!-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ -->
          <button
            @click="scrollToPrograms"
            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center active:scale-98"
          >
            <span>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</span>
            <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–µ—Ç -->
      <div
        v-if="!authorPrograms || authorPrograms.length === 0"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center"
      >
        <div class="text-4xl mb-4">‚ú®</div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          –ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        </h3>
        <p class="text-gray-600">
          –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö
        </p>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–≥—Ä–∞–º–º -->
      <div v-else ref="programsList" class="space-y-3">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
        <router-link
          v-for="program in authorPrograms"
          :key="program.id"
          :to="{
            name: 'AuthorProgramDetail',
            params: { id: program.id },
          }"
          class="block bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow duration-200 active:scale-98"
        >
          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
          <div class="px-4 py-4 bg-gradient-to-r from-amber-50 to-orange-50">
            <div class="flex items-start justify-between">
              <div class="flex items-start flex-1 min-w-0">
                <span class="text-2xl mr-3 flex-shrink-0">‚ú®</span>
                <div class="flex-1 min-w-0">
                  <h2
                    class="font-bold text-gray-900 text-base leading-tight mb-1"
                  >
                    {{ program.name }}
                  </h2>
                  <p
                    v-if="program.short_description"
                    class="text-sm text-gray-600 line-clamp-2"
                  >
                    {{ program.short_description }}
                  </p>
                </div>
              </div>
              <svg
                class="w-5 h-5 text-gray-400 flex-shrink-0 ml-2 mt-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </div>
          </div>

          <!-- –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
          <div class="px-4 py-3 space-y-2">
            <!-- –¶–µ–Ω–∞ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <!-- –¶–µ–Ω–∞ -->
              <div
                v-if="getPriceRange(program)"
                class="bg-green-50 text-green-800 px-3 py-1.5 rounded-lg border border-green-200 text-sm font-semibold"
              >
                {{ getPriceRange(program) }}
              </div>

              <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
              <div
                v-if="getDurationRange(program)"
                class="bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg border border-gray-200 text-sm flex items-center"
              >
                <svg
                  class="w-4 h-4 mr-1"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"
                  />
                </svg>
                {{ getDurationRange(program) }}
              </div>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div
              v-if="getGuestsRange(program)"
              class="text-xs text-gray-500 flex items-center"
            >
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"
                />
              </svg>
              {{ getGuestsRange(program) }}
            </div>
          </div>
        </router-link>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è -->
    <div v-else-if="activeTab === 'gallery'">
      <MediaGallery
        :sections="gallerySections"
        :show-media-type-filter="true"
        :category-labels="categoryLabels"
      />
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–±–æ—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
    <div
      v-if="showRecommendationModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      @click.self="closeRecommendationModal"
    >
      <div
        class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto"
      >
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div
          class="sticky top-0 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-5 py-4 rounded-t-xl z-10"
        >
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-lg">–ü–æ–¥–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã</h3>
            <button
              @click="closeRecommendationModal"
              class="text-white hover:text-gray-200"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="p-5 max-h-[60vh] overflow-y-auto">
          <!-- –®–∞–≥ 1: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
          <div v-if="recommendationStep === 1">
            <h4 class="font-semibold text-gray-900 mb-3">
              –ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–π—á–∞—Å?
            </h4>
            <div class="space-y-2">
              <button
                v-for="mood in currentMoodOptions"
                :key="mood.value"
                @click="selectCurrentMood(mood.value)"
                class="w-full bg-gray-50 hover:bg-amber-50 border border-gray-200 hover:border-amber-300 rounded-xl p-4 text-left transition-all duration-200 active:scale-98"
              >
                <div class="flex items-center">
                  <span class="text-2xl mr-3">{{ mood.emoji }}</span>
                  <div>
                    <div class="font-medium text-gray-900">
                      {{ mood.label }}
                    </div>
                    <div class="text-sm text-gray-500">
                      {{ mood.description }}
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 2: –ñ–µ–ª–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
          <div v-if="recommendationStep === 2">
            <button
              @click="recommendationStep = 1"
              class="flex items-center text-gray-600 hover:text-gray-800 mb-4 text-sm"
            >
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                  clip-rule="evenodd"
                />
              </svg>
              –ù–∞–∑–∞–¥
            </button>

            <h4 class="font-semibold text-gray-900 mb-3">
              –ö–∞–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å?
            </h4>
            <div class="space-y-2">
              <button
                v-for="mood in desiredMoodOptions"
                :key="mood.value"
                @click="selectDesiredMood(mood.value)"
                :disabled="isLoadingRecommendation"
                class="w-full bg-gray-50 hover:bg-amber-50 border border-gray-200 hover:border-amber-300 rounded-xl p-4 text-left transition-all duration-200 active:scale-98 disabled:opacity-50"
              >
                <div class="flex items-center">
                  <span class="text-2xl mr-3">{{ mood.emoji }}</span>
                  <div>
                    <div class="font-medium text-gray-900">
                      {{ mood.label }}
                    </div>
                    <div class="text-sm text-gray-500">
                      {{ mood.description }}
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- –®–∞–≥ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
          <div v-if="recommendationStep === 3 && recommendedProgram">
            <div class="text-center mb-4">
              <div class="text-4xl mb-3">‚ú®</div>
              <h4 class="font-bold text-xl text-gray-900 mb-2">
                –ú—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º
              </h4>
              <p class="text-sm text-gray-600">{{ recommendation.reason }}</p>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
            <div
              class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border-2 border-amber-200 p-4 mb-4"
            >
              <h3 class="font-bold text-lg text-gray-900 mb-2">
                {{ recommendedProgram.name }}
              </h3>
              <p class="text-sm text-gray-600 mb-3">
                {{ recommendedProgram.short_description }}
              </p>

              <!-- –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
              <div class="space-y-2">
                <div
                  v-if="getPriceRange(recommendedProgram)"
                  class="flex items-center justify-between text-sm"
                >
                  <span class="text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                  <span class="font-semibold text-green-700">{{
                    getPriceRange(recommendedProgram)
                  }}</span>
                </div>
                <div
                  v-if="getDurationRange(recommendedProgram)"
                  class="flex items-center justify-between text-sm"
                >
                  <span class="text-gray-600">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                  <span class="font-semibold text-gray-900">{{
                    getDurationRange(recommendedProgram)
                  }}</span>
                </div>
              </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="space-y-2">
              <router-link
                :to="{
                  name: 'AuthorProgramDetail',
                  params: { id: recommendedProgram.id },
                }"
                @click="closeRecommendationModal"
                class="block w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 text-center active:scale-98"
              >
                –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ
              </router-link>
              <button
                @click="resetRecommendation"
                class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl transition-all duration-200 active:scale-98"
              >
                –ü–æ–¥–æ–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
              </button>
            </div>
          </div>

          <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
          <div v-if="isLoadingRecommendation" class="flex justify-center py-8">
            <div class="relative">
              <div
                class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200"
              ></div>
              <div
                class="animate-spin rounded-full h-12 w-12 border-4 border-amber-500 border-t-transparent absolute top-0 left-0"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { mapState, mapActions } from "pinia";
import { useAppStore } from "@/stores/appStore";
import { programAPI } from "@/utils/api";
import MediaGallery from "@/components/MediaGallery.vue";

export default {
  name: "AuthorProgramsPage",
  components: {
    MediaGallery,
  },
  data() {
    return {
      isLoading: false,
      error: null,
      authorPrograms: [],
      pageContent: null,
      showRecommendationModal: false,
      recommendationStep: 1,
      selectedCurrentMood: null,
      selectedDesiredMood: null,
      isLoadingRecommendation: false,
      recommendation: null,
      recommendedProgram: null,
      currentMoodOptions: [
        {
          value: "stress",
          label: "–í —Å—Ç—Ä–µ—Å—Å–µ",
          description: "–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å",
          emoji: "üò∞",
        },
        {
          value: "tired",
          label: "–£—Å—Ç–∞–≤—à–∏–π",
          description: "–ù—É–∂–µ–Ω –æ—Ç–¥—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
          emoji: "üò¥",
        },
        {
          value: "curious",
          label: "–õ—é–±–æ–ø—ã—Ç–Ω—ã–π",
          description: "–•–æ—á—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ",
          emoji: "ü§î",
        },
        {
          value: "relax",
          label: "–°–ø–æ–∫–æ–π–Ω—ã–π",
          description: "–í—Å—ë —Ö–æ—Ä–æ—à–æ, —Ö–æ—á—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
          emoji: "üòå",
        },
        {
          value: "reboot",
          label: "–ù—É–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞",
          description: "–•–æ—á—É –æ–±–Ω–æ–≤–∏—Ç—å—Å—è",
          emoji: "üîÑ",
        },
      ],
      desiredMoodOptions: [
        {
          value: "deep_relax",
          label: "–ì–ª—É–±–æ–∫–æ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ",
          description: "–ü–æ–ª–Ω—ã–π –ø–æ–∫–æ–π –∏ –æ—Ç–¥—ã—Ö",
          emoji: "üßò",
        },
        {
          value: "energy",
          label: "–≠–Ω–µ—Ä–≥–∏—è",
          description: "–ü—Ä–∏–ª–∏–≤ —Å–∏–ª –∏ –±–æ–¥—Ä–æ—Å—Ç–∏",
          emoji: "‚ö°",
        },
        {
          value: "experience",
          label: "–ù–æ–≤—ã–π –æ–ø—ã—Ç",
          description: "–Ø—Ä–∫–∏–µ –æ—â—É—â–µ–Ω–∏—è",
          emoji: "‚ú®",
        },
        {
          value: "body",
          label: "–†–∞–±–æ—Ç–∞ —Å —Ç–µ–ª–æ–º",
          description: "–¢–µ–ª–µ—Å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏",
          emoji: "üíÜ",
        },
        {
          value: "clarity",
          label: "–Ø—Å–Ω–æ—Å—Ç—å",
          description: "–ß–∏—Å—Ç–æ—Ç–∞ –º—ã—Å–ª–µ–π –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è",
          emoji: "üåü",
        },
      ],
      activeTab: "info", // 'info' –∏–ª–∏ 'gallery'
    };
  },
  computed: {
    ...mapState(useAppStore, ["selectedBranch", "contentData"]),

    gallerySections() {
      return ["AUTHOR"];
    },

    categoryLabels() {
      return {
        AUTHOR: "–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
      };
    },
  },
  methods: {
    ...mapActions(useAppStore, ["loadSiteContent"]),

    formatPrice(price) {
      if (!price && price !== 0) return "";
      const priceNumber = Number(price);
      if (isNaN(priceNumber)) return price;
      return priceNumber.toLocaleString("ru-RU") + " ‚ÇΩ";
    },

    getPriceRange(program) {
      if (!program.pricing_tiers || program.pricing_tiers.length === 0) {
        return null;
      }

      const activeTiers = program.pricing_tiers.filter(
        (t) => t.is_active !== false
      );
      if (activeTiers.length === 0) return null;

      const prices = activeTiers.map((tier) => tier.price);
      const minPrice = Math.min(...prices);
      const maxPrice = Math.max(...prices);

      if (minPrice === maxPrice) {
        return this.formatPrice(minPrice);
      } else {
        return `${this.formatPrice(minPrice)} - ${this.formatPrice(maxPrice)}`;
      }
    },

    getDurationRange(program) {
      if (!program.pricing_tiers || program.pricing_tiers.length === 0) {
        return null;
      }

      const activeTiers = program.pricing_tiers.filter(
        (t) => t.is_active !== false
      );
      if (activeTiers.length === 0) return null;

      const durations = activeTiers.map((tier) => tier.duration_minutes);
      const minDuration = Math.min(...durations);
      const maxDuration = Math.max(...durations);

      if (minDuration === maxDuration) {
        return this.formatDuration(minDuration);
      } else {
        return `${this.formatDuration(minDuration)} - ${this.formatDuration(maxDuration)}`;
      }
    },

    getGuestsRange(program) {
      if (!program.pricing_tiers || program.pricing_tiers.length === 0) {
        if (program.max_participants) {
          return `–î–æ ${program.max_participants} –≥–æ—Å—Ç–µ–π`;
        }
        return null;
      }

      const activeTiers = program.pricing_tiers.filter(
        (t) => t.is_active !== false
      );
      if (activeTiers.length === 0) return null;

      const minGuests = Math.min(...activeTiers.map((tier) => tier.min_guests));
      const maxGuests = Math.max(...activeTiers.map((tier) => tier.max_guests));

      if (minGuests === maxGuests) {
        return `${minGuests} ${minGuests === 1 ? "–≥–æ—Å—Ç—å" : minGuests <= 4 ? "–≥–æ—Å—Ç—è" : "–≥–æ—Å—Ç–µ–π"}`;
      } else {
        return `${minGuests}-${maxGuests} –≥–æ—Å—Ç–µ–π`;
      }
    },

    formatDuration(minutes) {
      if (!minutes) return "";
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;

      if (hours > 0 && mins > 0) {
        return `${hours} —á ${mins} –º–∏–Ω`;
      } else if (hours > 0) {
        return `${hours} —á`;
      } else {
        return `${mins} –º–∏–Ω`;
      }
    },

    async loadPageContent() {
      try {
        await this.loadSiteContent("AUTHOR");
        const content = this.contentData?.["AUTHOR"];
        if (content && content.content) {
          this.pageContent = content.content;
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:", error);
      }
    },

    async loadAuthorPrograms() {
      try {
        this.isLoading = true;
        this.error = null;

        console.log(
          "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞:",
          this.selectedBranch?.id
        );

        const branchId = this.selectedBranch?.id;
        if (!branchId) {
          throw new Error("–§–∏–ª–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
        }

        const data = await programAPI.getAuthor(branchId);

        if (data && Array.isArray(data.programs)) {
          this.authorPrograms = data.programs.filter(
            (program) => program.is_active !== false
          );
          console.log(
            "–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º:",
            this.authorPrograms.length
          );
        } else {
          this.authorPrograms = [];
          console.log("–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º:", error);
        this.error =
          error.message ||
          "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö";
        this.authorPrograms = [];
      } finally {
        this.isLoading = false;
      }
    },

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    openRecommendationModal() {
      this.showRecommendationModal = true;
      this.recommendationStep = 1;
      this.selectedCurrentMood = null;
      this.selectedDesiredMood = null;
      this.recommendation = null;
      this.recommendedProgram = null;
    },

    closeRecommendationModal() {
      this.showRecommendationModal = false;
    },

    selectCurrentMood(mood) {
      this.selectedCurrentMood = mood;
      this.recommendationStep = 2;
    },

    async selectDesiredMood(mood) {
      this.selectedDesiredMood = mood;
      await this.getRecommendation();
    },

    async getRecommendation() {
      try {
        this.isLoadingRecommendation = true;

        const branchId = this.selectedBranch?.id;
        if (!branchId) {
          throw new Error("–§–∏–ª–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
        }

        console.log("–ó–∞–ø—Ä–æ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:", {
          current_mood: this.selectedCurrentMood,
          desired_mood: this.selectedDesiredMood,
        });

        const data = await programAPI.getAuthorRecommendation(
          branchId,
          this.selectedCurrentMood,
          this.selectedDesiredMood
        );

        if (data && data.recommendation && data.program) {
          this.recommendation = data.recommendation;
          this.recommendedProgram = data.program;
          this.recommendationStep = 3;
          console.log("–ü–æ–ª—É—á–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:", data);
        } else {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
        this.recommendationStep = 1;
      } finally {
        this.isLoadingRecommendation = false;
      }
    },

    resetRecommendation() {
      this.recommendationStep = 1;
      this.selectedCurrentMood = null;
      this.selectedDesiredMood = null;
      this.recommendation = null;
      this.recommendedProgram = null;
    },

    scrollToPrograms() {
      if (this.$refs.programsList) {
        this.$refs.programsList.scrollIntoView({
          behavior: "smooth",
          block: "start",
        });
      }
    },
  },
  async created() {
    console.log("AuthorProgramsPage created");
    await Promise.all([this.loadPageContent(), this.loadAuthorPrograms()]);
  },

  watch: {
    "selectedBranch.id": {
      handler(newBranchId) {
        console.log(
          "–§–∏–ª–∏–∞–ª –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∞–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:",
          newBranchId
        );
        this.loadPageContent();
        this.loadAuthorPrograms();
      },
    },
  },
};
</script>

<style scoped>
.active\:scale-98:active {
  transform: scale(0.98);
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
