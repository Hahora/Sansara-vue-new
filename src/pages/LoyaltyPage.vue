<template>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white pb-20">
    <!-- –®–∞–ø–∫–∞ -->
    <div
      class="bg-gradient-to-br from-[#4e5d51] via-[#5a6d5e] to-[#4e5d51] text-white px-5 py-6"
    >
      <div class="flex items-center mb-4">
        <button
          @click="$router.go(-1)"
          class="flex items-center text-white hover:text-gray-200 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd"
            />
          </svg>
          <span class="font-medium">–ù–∞–∑–∞–¥</span>
        </button>
      </div>

      <div class="flex items-center">
        <div
          class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-full flex items-center justify-center text-3xl border-2 border-white border-opacity-30"
        >
          üéÅ
        </div>
        <div class="ml-4 flex-1">
          <h1 class="text-2xl font-bold">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h1>
          <p class="text-white text-opacity-90 text-sm mt-1">
            –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
          </p>
        </div>
      </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="isLoading" class="flex justify-center items-center py-16">
      <div class="relative">
        <div class="rounded-full h-12 w-12 border-4 border-gray-200"></div>
        <div
          class="rounded-full h-12 w-12 border-4 border-[#4e5d51] border-t-transparent absolute top-0 left-0"
        ></div>
      </div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div
      v-else-if="error"
      class="mx-4 mt-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4 shadow-sm"
    >
      <div class="flex items-start">
        <svg
          class="h-5 w-5 text-red-500 mt-0.5 mr-3"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="text-sm text-red-800">{{ error }}</p>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div v-else class="px-4 py-5">
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
      <div
        class="flex bg-white rounded-xl shadow-sm border border-gray-200 p-1 mb-6"
      >
        <button
          @click="activeTab = 'loyalty'"
          :class="[
            'flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-all',
            activeTab === 'loyalty'
              ? 'bg-[#4e5d51] text-white shadow-sm'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          <div class="flex items-center justify-center">
            <span class="text-lg mr-2">üëë</span>
            <span>–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</span>
          </div>
        </button>

        <button
          @click="activeTab = 'promo'"
          :class="[
            'flex-1 py-3 px-4 rounded-lg font-medium text-sm transition-all',
            activeTab === 'promo'
              ? 'bg-[#4e5d51] text-white shadow-sm'
              : 'text-gray-600 hover:text-gray-900',
          ]"
        >
          <div class="flex items-center justify-center">
            <span class="text-lg mr-2">üè∑Ô∏è</span>
            <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã ({{ promoCodes.length }})</span>
          </div>
        </button>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
      <div>
        <!-- –í–∫–ª–∞–¥–∫–∞: –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ -->
        <div v-if="activeTab === 'loyalty'">
          <!-- –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ -->
          <div
            v-if="!loyaltyInfo"
            class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center"
          >
            <div class="text-4xl mb-4">üëë</div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
            </h3>
            <p class="text-gray-600">
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è
            </p>
          </div>

          <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ -->
          <div v-else class="space-y-4">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ -->
            <div
              class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
            >
              <div
                class="px-4 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-100"
              >
                <div class="flex items-center">
                  <span class="text-3xl mr-3">üëë</span>
                  <div class="flex-1">
                    <h2 class="font-bold text-gray-900 text-lg">
                      {{ loyaltyInfo.title || "–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" }}
                    </h2>
                  </div>
                </div>
              </div>

              <div class="p-4">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ API -->
                <div
                  v-if="loyaltyInfo.content"
                  class="prose prose-sm max-w-none"
                >
                  <div v-html="formatContent(loyaltyInfo.content)"></div>
                </div>

                <!-- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç -->
                <div v-else class="text-gray-500 italic text-center py-4">
                  –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–æ–º–æ–∫–æ–¥—ã -->
        <div v-else>
          <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
          <div
            class="mb-6 bg-white rounded-xl shadow-sm border border-gray-100 p-4"
          >
            <h3 class="text-sm font-semibold text-gray-700 mb-3">
              –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="text-center">
                <div class="text-2xl font-bold text-gray-900">
                  {{ promoCodes.length }}
                </div>
                <div class="text-xs text-gray-500">–í—Å–µ–≥–æ</div>
              </div>

              <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">
                  {{ firstVisitPromosCount }}
                </div>
                <div class="text-xs text-gray-500">–î–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞</div>
              </div>
            </div>
          </div>

          <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
          <div v-if="promoCodes && promoCodes.length > 0" class="space-y-4">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
            <div
              v-for="promo in promoCodes"
              :key="promo.id"
              class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
            >
              <!-- –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ -->
              <div :class="getPromoColorClass(promo)" class="h-1"></div>

              <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
              <div class="px-4 py-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h2 class="font-bold text-gray-900 text-lg">
                        {{ promo.code }}
                      </h2>
                      <span class="text-sm text-gray-500"
                        >ID: {{ promo.id }}</span
                      >
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å—ã -->
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                      <span
                        v-if="promo.is_active"
                        class="text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded border border-green-200"
                      >
                        –ê–∫—Ç–∏–≤–µ–Ω
                      </span>
                      <span
                        v-else
                        class="text-xs bg-red-50 text-red-700 px-2 py-0.5 rounded border border-red-200"
                      >
                        –ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                      </span>
                      <span
                        v-if="promo.for_first_visit_only"
                        class="text-xs bg-purple-50 text-purple-700 px-2 py-0.5 rounded border border-purple-200"
                      >
                        –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç
                      </span>
                    </div>
                  </div>

                  <!-- –°–∫–∏–¥–∫–∞ -->
                  <div
                    class="px-3 py-1 bg-blue-50 text-blue-700 rounded-lg text-sm font-semibold"
                  >
                    -{{ promo.discount_percent }}%
                  </div>
                </div>
              </div>

              <div class="px-4 pb-4 space-y-3">
                <!-- –¢–∏–ø—ã –ø—Ä–æ–≥—Ä–∞–º–º -->
                <div>
                  <div class="text-xs font-medium text-gray-700 mb-2">
                    –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫:
                  </div>
                  <div
                    v-if="promo.program_types && promo.program_types.length > 0"
                    class="flex flex-wrap gap-1"
                  >
                    <span
                      v-for="type in promo.program_types"
                      :key="type"
                      class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border"
                    >
                      {{ getProgramTypeLabel(type) }}
                    </span>
                  </div>
                  <div v-else class="text-sm text-gray-600">
                    –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º
                  </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–∏–∏ -->
                <div class="pt-3 border-t border-gray-100">
                  <div class="flex items-center text-xs text-gray-500">
                    <svg
                      class="w-3 h-3 mr-1"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    –°–æ–∑–¥–∞–Ω: {{ formatDateTime(promo.created_at) }}
                  </div>
                </div>

                <!-- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å -->
                <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                  <div class="text-xs font-medium text-gray-700 mb-1">
                    –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
                  </div>
                  <p class="text-xs text-gray-600">
                    –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥
                    <span class="font-mono font-bold text-blue-700">{{
                      promo.code
                    }}</span>
                    –≤ –ø–æ–ª–µ "–ü—Ä–æ–º–æ–∫–æ–¥".
                    <span
                      v-if="promo.for_first_visit_only"
                      class="text-blue-600 font-medium"
                    >
                      –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞.
                    </span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
          <div
            v-else
            class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center"
          >
            <div class="text-4xl mb-4">üè∑Ô∏è</div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
            </h3>
            <p class="text-gray-600">–°–µ–π—á–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { mapState, mapActions } from "pinia";
import { useAppStore } from "@/stores/appStore";
import { loyaltyAPI } from "@/utils/api";

export default {
  name: "LoyaltyPage",
  data() {
    return {
      isLoading: false,
      error: null,
      loyaltyInfo: null, // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ LOYALTY
      promoCodes: [], // –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏–∑ API
      activeTab: "loyalty",
    };
  },
  computed: {
    ...mapState(useAppStore, ["selectedBranch", "contentData"]),

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    activePromosCount() {
      return this.promoCodes.filter((promo) => promo.is_active).length;
    },

    totalUses() {
      return this.promoCodes.reduce(
        (sum, promo) => sum + (promo.current_uses || 0),
        0
      );
    },

    firstVisitPromosCount() {
      return this.promoCodes.filter((promo) => promo.for_first_visit_only)
        .length;
    },
  },
  methods: {
    ...mapActions(useAppStore, ["loadSiteContent"]),

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    formatContent(content) {
      if (!content) return "";
      return content
        .replace(/\n/g, "<br>")
        .replace(/\\n/g, "<br>")
        .replace(/\r\n/g, "<br>");
    },

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    formatDate(dateString) {
      if (!dateString) return "";
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString("ru-RU", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      } catch (e) {
        return dateString;
      }
    },

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    formatDateTime(dateString) {
      if (!dateString) return "";
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString("ru-RU", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      } catch (e) {
        return dateString;
      }
    },

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    getUsagePercentage(promo) {
      if (!promo.max_uses || promo.max_uses === 0) return 0;
      return Math.min(
        100,
        Math.round((promo.current_uses / promo.max_uses) * 100)
      );
    },

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
    getPromoColorClass(promo) {
      if (!promo.is_active) return "bg-gray-400";
      if (promo.for_first_visit_only) return "bg-purple-500";

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
      if (promo.valid_until) {
        const now = new Date();
        const validUntil = new Date(promo.valid_until);
        if (validUntil < now) return "bg-red-500";
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
      if (promo.max_uses && promo.current_uses >= promo.max_uses) {
        return "bg-red-500";
      }

      return "bg-green-500";
    },

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
    getProgramTypeLabel(type) {
      const labels = {
        COLLECTIVE: "–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
        AUTHOR: "–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
        BACHELOR: "–ë–∞—Ç—á–µ–ª–ª—ã",
        CLUB_EVENT: "–ö–ª—É–±–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
        CERTIFICATE: "–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã",
      };
      return labels[type] || type;
    },

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ contentData
    async loadLoyaltyInfo() {
      try {
        await this.loadSiteContent("LOYALTY", true);

        const content = this.contentData?.["LOYALTY"];

        if (content && typeof content === "object") {
          this.loyaltyInfo = content;
          console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:", this.loyaltyInfo);
        } else {
          this.loyaltyInfo = null;
          console.log("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:", error);
        this.loyaltyInfo = null;
      }
    },

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏–∑ API
    async loadPromoCodes() {
      try {
        const promos = await loyaltyAPI.getPromos();
        console.log("–ü–æ–ª—É—á–µ–Ω—ã –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏–∑ API:", promos);

        if (Array.isArray(promos)) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ)
          this.promoCodes = promos.sort((a, b) => {
            // –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ, –ø–æ—Ç–æ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ
            if (a.is_active !== b.is_active) {
              return a.is_active ? -1 : 1;
            }
            // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
            return new Date(b.created_at) - new Date(a.created_at);
          });

          console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:", this.promoCodes.length);
          console.log("–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–∞:", this.promoCodes[0]);
        } else {
          this.promoCodes = [];
          console.log("–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –º–∞—Å—Å–∏–≤–∞");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:", error);
        this.promoCodes = [];
      }
    },

    // –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async loadData() {
      try {
        this.isLoading = true;
        this.error = null;

        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏");

        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±–µ —á–∞—Å—Ç–∏
        await Promise.all([this.loadLoyaltyInfo(), this.loadPromoCodes()]);

        console.log("–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ");
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:", error);
        this.error = error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é";
      } finally {
        this.isLoading = false;
      }
    },
  },
  async created() {
    console.log("LoyaltyPage created");

    try {
      await this.loadData();
      console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:", error);
      this.error = error.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã";
    }
  },

  // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª–∏–∞–ª–∞
  watch: {
    "selectedBranch.id": {
      handler(newBranchId) {
        console.log("–§–∏–ª–∏–∞–ª –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ:", newBranchId);
        this.loadData();
      },
    },
  },
};
</script>

<style scoped>
.prose :deep(p) {
  margin-bottom: 0.75em;
}

.prose :deep(ul) {
  margin-bottom: 0.75em;
  padding-left: 1.5em;
  list-style-type: disc;
}

.prose :deep(li) {
  margin-bottom: 0.25em;
}

.prose :deep(strong) {
  font-weight: 600;
  color: #111827;
}
</style>
